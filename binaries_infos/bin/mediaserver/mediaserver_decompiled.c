//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2018 Retargetable Decompiler <info@retdec.com>
//

#include <errno.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/wait.h>
#include <unistd.h>

// ------------------------ Structures ------------------------

struct _IO_FILE {
    int32_t e0;
    char * e1;
    char * e2;
    char * e3;
    char * e4;
    char * e5;
    char * e6;
    char * e7;
    char * e8;
    char * e9;
    char * e10;
    char * e11;
    struct _IO_marker * e12;
    struct _IO_FILE * e13;
    int32_t e14;
    int32_t e15;
    int32_t e16;
    int16_t e17;
    char e18;
    char e19[1];
    char * e20;
    int64_t e21;
    char * e22;
    char * e23;
    char * e24;
    char * e25;
    int32_t e26;
    int32_t e27;
    char e28[40];
};

struct _IO_marker {
    struct _IO_marker * e0;
    struct _IO_FILE * e1;
    int32_t e2;
};

// ------------------- Function Prototypes --------------------

int32_t media_service(int32_t argc, char ** argv);

// --------------------- Global Variables ---------------------

struct _IO_FILE * g1 = NULL; // 0x11268
struct _IO_FILE * g2 = NULL; // 0x11270
char * g3 = "\x1b\x5b\x30\x3b\x33\x30\x6d\x5b\x25\x73\x5d\x5b\x25\x73\x28\x29\x3a\x25\x64\x5d\x6d\x65\x64\x69\x61\x73\x65\x72\x76\x65\x72\x6d\x61\x69\x6e\x20\x73\x65\x72\x76\x65\x72\x20\x73\x74\x61\x72\x74\x0a"; // 0x8d4c
char * g4 = "\x1b\x5b\x30\x6d\x0a"; // 0x8d88
char * g5 = "\x1b\x5b\x30\x3b\x33\x30\x6d\x5b\x25\x73\x5d\x5b\x25\x73\x28\x29\x3a\x25\x64\x5d\x6d\x65\x64\x69\x61\x73\x65\x72\x76\x65\x72\x5b\x4d\x45\x44\x49\x41\x5f\x4d\x55\x4c\x54\x49\x5f\x50\x52\x4f\x43\x45\x53\x53\x20\x3d\x20\x25\x73\x5d\x0a"; // 0x8da4
char * g6 = "\x1b\x5b\x30\x3b\x33\x30\x6d\x5b\x25\x73\x5d\x5b\x25\x73\x28\x29\x3a\x25\x64\x5d\x6d\x65\x64\x69\x61\x73\x65\x72\x76\x65\x72\x5b\x63\x6f\x6d\x70\x69\x6c\x65\x5f\x64\x61\x74\x65\x3d\x25\x73\x5d\x3a\x5b\x73\x76\x6e\x5f\x76\x65\x72\x73\x69\x6f\x6e\x20\x3d\x20\x25\x73\x5d\x0a"; // 0x8de0

// ------------------------ Functions -------------------------

// From module:   /home/zhf/samba/TMER/core/media/src/intergrated/media_server/mediaserver/tcl_player_main.c
// Address range: 0x8abc - 0x8b53
// Line range:    210 - 257
int32_t media_service(int32_t argc, char ** argv) {
    int32_t items_written = setenv("MEDIA_PLAYER_CMD", "FALSE", 1); // R0
    mm_log_level_get();
    if (items_written >= 4) {
        // 0x8ae6
        fprintf(g2, (char *)&g3);
        items_written = fwrite((char *)&g4, 1, 5, g2);
        // branch -> 0x8b2c
    }
    // 0x8b2c
    tcl_gstplayer_server_init();
    if (items_written == -1) {
        // 0x8b3a
        return -1;
    }
    while (true) {
        // 0x8b40
        sleep(10);
        // branch -> 0x8b40
    }
}

// From module:   /home/zhf/samba/TMER/core/media/src/intergrated/media_server/mediaserver/tcl_player_main.c
// Address range: 0x8b54 - 0x8cdb
// Line range:    259 - 298
int main(int argc, char ** argv) {
    // 0x8b54
    int32_t v1;
    int32_t status = v1; // bp-28
    char * v2;
    char * value = v2; // bp-20
    value = NULL;
    char * env_val = getenv("MEDIA_MULTI_PROCESS"); // 0x8b6a
    int32_t v3 = (int32_t)env_val; // 0x8b6a_3
    int32_t items_written = v3; // R0
    value = env_val;
    mm_log_parse_env(v3);
    mm_log_level_get();
    if (items_written >= 4) {
        // 0x8b7e
        fprintf(g2, (char *)&g5);
        items_written = fwrite((char *)&g4, 1, 5, g2);
        // branch -> 0x8bca
    }
    // 0x8bca
    mm_log_level_get();
    if (items_written >= 4) {
        // 0x8bd4
        fprintf(g2, (char *)&g6);
        fwrite((char *)&g4, 1, 5, g2);
        // branch -> 0x8c30
    }
    // 0x8c30
    gst_init(0, 0);
    if (value == NULL) {
        // 0x8cc6
        media_service(argc, argv);
        // branch -> 0x8cd0
        // 0x8cd0
        return -1;
    }
    int32_t v4 = fork(); // 0x8c423
    char * err_str; // 0x8c6c
    int32_t v5; // 0x8c60
    int32_t err_num; // 0x8c68
    if (v4 == -1) {
        // 0x8c50
        v5 = *__errno_location();
        err_num = *__errno_location();
        err_str = strerror(err_num);
        fprintf(g2, "fork() error.errno:%d error:%sn", v5, err_str);
        // branch -> 0x8cd0
    } else {
        int32_t stat_loc = &status; // 0x8c9a_0
        // branch -> 0x8c84
        while (true) {
            // 0x8c84
            if (v4 == 0) {
                // 0x8c8a
                media_service(argc, argv);
                // branch -> 0x8cd0
                // 0x8cd0
                return 0;
            }
            // 0x8c94
            if (v4 >= 1) {
                // 0x8c9a
                wait(stat_loc);
                wait(stat_loc);
                fwrite("wait return", 1, 11, g1);
                // branch -> 0x8c42
            }
            int32_t v6 = fork(); // 0x8c42
            if (v6 == -1) {
                // break -> 0x8c50
                break;
            }
            v4 = v6;
            // continue -> 0x8c84
        }
        // 0x8c50
        v5 = *__errno_location();
        err_num = *__errno_location();
        err_str = strerror(err_num);
        fprintf(g2, "fork() error.errno:%d error:%sn", v5, err_str);
        // branch -> 0x8cd0
    }
    // 0x8cd0
    return 0;
}

// --------------- Dynamically Linked Functions ---------------

// int * __errno_location(void);
// __pid_t fork(void);
// int fprintf(FILE * restrict stream, const char * restrict format, ...);
// size_t fwrite(const void * restrict ptr, size_t size, size_t n, FILE * restrict s);
// char * getenv(const char * name);
// void gst_init(int32_t a1, int32_t a2);
// void mm_log_level_get(void);
// void mm_log_parse_env(int32_t a1);
// int setenv(const char * name, const char * value, int replace);
// unsigned int sleep(unsigned int seconds);
// char * strerror(int errnum);
// void tcl_gstplayer_server_init(void);
// __pid_t wait(__WAIT_STATUS stat_loc);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: gcc (4.7.3)
// Detected language: C++
// Detected functions: 2
// Decompiler release: v2.2.1 (2016-09-07)
// Decompilation date: 2018-03-05 18:49:01
